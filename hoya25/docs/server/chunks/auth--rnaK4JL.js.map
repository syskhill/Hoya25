{"version":3,"file":"auth--rnaK4JL.js","sources":["../../../.svelte-kit/adapter-node/chunks/auth.js"],"sourcesContent":["import { eq } from \"drizzle-orm\";\nimport { sha256 } from \"@oslojs/crypto/sha2\";\nimport { encodeBase64url, encodeHexLowerCase } from \"@oslojs/encoding\";\nimport { drizzle } from \"drizzle-orm/libsql\";\nimport { createClient } from \"@libsql/client\";\nimport { d as private_env } from \"./shared-server.js\";\nimport { sqliteTable, text, integer } from \"drizzle-orm/sqlite-core\";\nif (!private_env.DATABASE_URL) throw new Error(\"DATABASE_URL is not set\");\nconst client = createClient({ url: private_env.DATABASE_URL });\nconst db = drizzle(client);\nconst user = sqliteTable(\"user\", {\n  id: text(\"id\").primaryKey(),\n  age: integer(\"age\"),\n  username: text(\"username\").notNull().unique(),\n  passwordHash: text(\"password_hash\").notNull()\n});\nconst session = sqliteTable(\"session\", {\n  id: text(\"id\").primaryKey(),\n  userId: text(\"user_id\").notNull().references(() => user.id),\n  expiresAt: integer(\"expires_at\", { mode: \"timestamp\" }).notNull()\n});\nconst DAY_IN_MS = 1e3 * 60 * 60 * 24;\nconst sessionCookieName = \"auth-session\";\nfunction generateSessionToken() {\n  const bytes = crypto.getRandomValues(new Uint8Array(18));\n  const token = encodeBase64url(bytes);\n  return token;\n}\nasync function createSession(token, userId) {\n  const sessionId = encodeHexLowerCase(sha256(new TextEncoder().encode(token)));\n  const session$1 = {\n    id: sessionId,\n    userId,\n    expiresAt: new Date(Date.now() + DAY_IN_MS * 30)\n  };\n  await db.insert(session).values(session$1);\n  return session$1;\n}\nasync function validateSessionToken(token) {\n  const sessionId = encodeHexLowerCase(sha256(new TextEncoder().encode(token)));\n  const [result] = await db.select({\n    // Adjust user table here to tweak returned data\n    user: { id: user.id, username: user.username },\n    session\n  }).from(session).innerJoin(user, eq(session.userId, user.id)).where(eq(session.id, sessionId));\n  if (!result) {\n    return { session: null, user: null };\n  }\n  const { session: session$1, user: user$1 } = result;\n  const sessionExpired = Date.now() >= session$1.expiresAt.getTime();\n  if (sessionExpired) {\n    await db.delete(session).where(eq(session.id, session$1.id));\n    return { session: null, user: null };\n  }\n  const renewSession = Date.now() >= session$1.expiresAt.getTime() - DAY_IN_MS * 15;\n  if (renewSession) {\n    session$1.expiresAt = new Date(Date.now() + DAY_IN_MS * 30);\n    await db.update(session).set({ expiresAt: session$1.expiresAt }).where(eq(session.id, session$1.id));\n  }\n  return { session: session$1, user: user$1 };\n}\nasync function invalidateSession(sessionId) {\n  await db.delete(session).where(eq(session.id, sessionId));\n}\nfunction setSessionTokenCookie(event, token, expiresAt) {\n  event.cookies.set(sessionCookieName, token, {\n    expires: expiresAt,\n    path: \"/\"\n  });\n}\nfunction deleteSessionTokenCookie(event) {\n  event.cookies.delete(sessionCookieName, {\n    path: \"/\"\n  });\n}\nexport {\n  db as a,\n  sessionCookieName as b,\n  createSession as c,\n  deleteSessionTokenCookie as d,\n  generateSessionToken as g,\n  invalidateSession as i,\n  setSessionTokenCookie as s,\n  user as u,\n  validateSessionToken as v\n};\n"],"names":[],"mappings":"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"}